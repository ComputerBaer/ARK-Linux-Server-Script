#!/bin/bash

# Version Checker 
versionP="1.0.6"

source ../version.ini
source ../configuration.ini
source formatting.ini

source _functions

# Compare Versions
if [ $versionP != $parameters ]; then
    echo -e "$ERR Script update available! (Parameters Check Script) $RESET"
    echo -e; echo -e "$YELLOW Downloading script file. $RESET"
    curl https://raw.githubusercontent.com/Zendrex/ARK-Linux-Server-Script/master/.serverscript/parameters_check -o parameters_check -#
    echo -e; echo -e "$GREEN File overwritten. Please restart the script. $RESET"
    exit 0
else
    echo -e " Param Script Up to date!"; echo -e
    sleep 1s
fi

echo -e "$YELLOW Checking parameters. $RESET"; echo -e

# Parameters String
executeString=""

# Map Name (must be the first option !!!)
if [[ -z $map ]]; then
    executeString="${executeString}TheIsland"
else
    executeString="${executeString}${map}"
fi

# Server
executeString="${executeString}?listen"

########################
## Boolean Parameters ##
########################

# Dont Always Notify Player Joined
notifyJoin=$(checkBoolean $notifyJoin false)
notifyJoin=$(invertBoolean $notifyJoin) # Variable is NotifyJoin, Parameter is DontNotifyJoin
executeString="${executeString}?DontAlwaysNotifyPlayerJoined=${notifyJoin}"

# Always Notify Player Left
notifyLeft=$(checkBoolean $notifyLeft false)
executeString="${executeString}?AlwaysNotifyPlayerLeft=${notifyLeft}"

# Allow Third Person Player
thirdPerson=$(checkBoolean $thirdPerson false)
executeString="${executeString}?AllowThirdPersonPlayer=${thirdPerson}"

# Global Voice Chat
globalVoice=$(checkBoolean $globalVoice false)
executeString="${executeString}?GlobalVoiceChat=${globalVoice}"

# Show Map Player Location
showPlayers=$(checkBoolean $showPlayers false)
executeString="${executeString}?ShowMapPlayerLocation=${showPlayers}"

# No Tribute Downloads
noTributeDl=$(checkBoolean $noTributeDl false)
executeString="${executeString}?NoTributeDownloads=${noTributeDl}"

# Proximity Chat
proxChat=$(checkBoolean $proxChat false)
executeString="${executeString}?ProximityChat=${proxChat}"

# Server PvE
pveServer=$(checkBoolean $pveServer false)
executeString="${executeString}?ServerPVE=${pveServer}"

# Server Hardcore
hardcore=$(checkBoolean $hardcore false)
executeString="${executeString}?ServerHardcore=${hardcore}"

# Server Force No Hud
noHud=$(checkBoolean $noHud false)
executeString="${executeString}?ServerForceNoHUD=${noHud}"

# Server Crosshair
crossHair=$(checkBoolean $crossHair false)
executeString="${executeString}?ServerCrosshair=${crossHair}"

# Enable PvP Gamma
enablePvPGamma=$(checkBoolean $enablePvPGamma false)
executeString="${executeString}?EnablePvPGamma=${enablePvPGamma}"

# Disable Structure Decay PvE (NEW)
disableStructureDecayPvE=$(checkBoolean $disableStructureDecayPvE false)
executeString="${executeString}?DisableStructureDecayPvE=${disableStructureDecayPvE}"

# Allow Flyer Carry PvE (NEW)
allowFlyerCarryPvE=$(checkBoolean $allowFlyerCarryPvE false)
executeString="${executeString}?AllowFlyerCarryPvE=${allowFlyerCarryPvE}"

# Clamp Resource Harvest Damage (NEW)
ClampResourceHarvestDamage=$(checkBoolean $ClampResourceHarvestDamage false)
executeString="${executeString}?ClampResourceHarvestDamage=${ClampResourceHarvestDamage}"

# RCON Enabled
if [[ -z $adminPass ]]; then
    rconEnabled="false"
fi
rconEnabled=$(checkBoolean $rconEnabled false)
executeString="${executeString}?RCONEnabled=${rconEnabled}"

########################
## Integer Parameters ##
########################

# Max Structures In Range
MaxStructuresInRange=$(checkInteger $MaxStructuresInRange 1300)
executeString="${executeString}?MaxStructuresInRange=${MaxStructuresInRange}"

# PvE Structure Decay Destruction Period ( Not in GameUserSettings.ini ? )
PvEStructureDecayDestructionPeriod=$(checkInteger $PvEStructureDecayDestructionPeriod 0)
executeString="${executeString}?PvEStructureDecayDestructionPeriod=${PvEStructureDecayDestructionPeriod}"

# Max Players
playerCount=$(checkInteger $playerCount 70)
executeString="${executeString}?MaxPlayers=${playerCount}"

# Kick Idle Players Period (AFK Timer)
afkTimer=$(checkInteger $afkTimer 2400)
executeString="${executeString}?KickIdlePlayersPeriod=${afkTimer}"

# Auto Save Period Minutes
autoSave=$(checkInteger $autoSave 15)
executeString="${executeString}?AutoSavePeriodMinutes=${autoSave}"

# Port
gamePort=$(checkInteger $gamePort 7777)
executeString="${executeString}?Port=${gamePort}"

# Query Port
queryPort=$(checkInteger $queryPort 27015)
executeString="${executeString}?QueryPort=${queryPort}"

# RCON Port
rconPort=$(checkInteger $rconPort 32330)
executeString="${executeString}?RCONPort=${rconPort}"

########################
## String Parameters  ##
########################

# Server Password
executeString="${executeString}?ServerPassword=${serverPass}"

# Server Admin Password
executeString="${executeString}?ServerAdminPassword=${adminPass}"

# Session Name
executeString="${executeString}?SessionName=${hostName}"

# Multi Home (IP Address)
executeString="${executeString}?MultiHome=${ipAddress}"

########################
## Double Parameters  ##
########################

# Day Cycle Speed Scale
DayCycleSpeedScale=$(checkDouble $DayCycleSpeedScale 1.0)
executeString="${executeString}?DayCycleSpeedScale=${DayCycleSpeedScale}"

# Night Time Speed Scale
NightTimeSpeedScale=$(checkDouble $NightTimeSpeedScale 1.0)
executeString="${executeString}?NightTimeSpeedScale=${NightTimeSpeedScale}"

# Day Time Speed Scale
DayTimeSpeedScale=$(checkDouble $DayTimeSpeedScale 1.0)
executeString="${executeString}?DayTimeSpeedScale=${DayTimeSpeedScale}"

# Dino Damage Multiplier
DinoDamageMultiplier=$(checkDouble $DinoDamageMultiplier 1.0)
executeString="${executeString}?DinoDamageMultiplier=${DinoDamageMultiplier}"

# Tamed Dino Damage Multiplier ( Not in GameUserSettings.ini ? )
TamedDinoDamageMultiplier=$(checkDouble $TamedDinoDamageMultiplier 1.0)
executeString="${executeString}?TamedDinoDamageMultiplier=${TamedDinoDamageMultiplier}"

# Player Damage Multiplier
PlayerDamageMultiplier=$(checkDouble $PlayerDamageMultiplier 1.0)
executeString="${executeString}?PlayerDamageMultiplier=${PlayerDamageMultiplier}"

# Structure Damage Multiplier
StructureDamageMultiplier=$(checkDouble $StructureDamageMultiplier 1.0)
executeString="${executeString}?StructureDamageMultiplier=${StructureDamageMultiplier}"

# Player Resistance Multiplier
PlayerResistanceMultiplier=$(checkDouble $PlayerResistanceMultiplier 1.0)
executeString="${executeString}?PlayerResistanceMultiplier=${PlayerResistanceMultiplier}"

# Dino Resistance Multiplier
DinoResistanceMultiplier=$(checkDouble $DinoResistanceMultiplier 1.0)
executeString="${executeString}?DinoResistanceMultiplier=${DinoResistanceMultiplier}"

# Tamed Dino Resistance Multiplier ( Not in GameUserSettings.ini ? )
TamedDinoResistanceMultiplier=$(checkDouble $TamedDinoResistanceMultiplier 1.0)
executeString="${executeString}?TamedDinoResistanceMultiplier=${TamedDinoResistanceMultiplier}"

# Structure Resistance Multiplier
StructureResistanceMultiplier=$(checkDouble $StructureResistanceMultiplier 1.0)
executeString="${executeString}?StructureResistanceMultiplier=${StructureResistanceMultiplier}"

# XP Multiplier
XPMultiplier=$(checkDouble $XPMultiplier 1.0)
executeString="${executeString}?XPMultiplier=${XPMultiplier}"

# PvE Structure Decay Period Multiplier (NEW)
PvEStructureDecayPeriodMultiplier=$(checkDouble $PvEStructureDecayPeriodMultiplier 1.0)
executeString="${executeString}?PvEStructureDecayPeriodMultiplier=${PvEStructureDecayPeriodMultiplier}"

# Taming Speed Multiplier
TamingSpeedMultiplier=$(checkDouble $TamingSpeedMultiplier 1.0)
executeString="${executeString}?TamingSpeedMultiplier=${TamingSpeedMultiplier}"

# Harvest Amount Multiplier
HarvestAmountMultiplier=$(checkDouble $HarvestAmountMultiplier 1.0)
executeString="${executeString}?HarvestAmountMultiplier=${HarvestAmountMultiplier}"

# Harvest Health Multiplier
HarvestHealthMultiplier=$(checkDouble $HarvestHealthMultiplier 1.0)
executeString="${executeString}?HarvestHealthMultiplier=${HarvestHealthMultiplier}"

# Resources Respawn Period Multiplier (NEW)
ResourcesRespawnPeriodMultiplier=$(checkDouble $ResourcesRespawnPeriodMultiplier 1.0)
executeString="${executeString}?ResourcesRespawnPeriodMultiplier=${ResourcesRespawnPeriodMultiplier}"

# Player Character Water Drain Multiplier
PlayerCharacterWaterDrainMultiplier=$(checkDouble $PlayerCharacterWaterDrainMultiplier 1.0)
executeString="${executeString}?PlayerCharacterWaterDrainMultiplier=${PlayerCharacterWaterDrainMultiplier}"

# Player Character Food Drain Multiplier
PlayerCharacterFoodDrainMultiplier=$(checkDouble $PlayerCharacterFoodDrainMultiplier 1.0)
executeString="${executeString}?PlayerCharacterFoodDrainMultiplier=${PlayerCharacterFoodDrainMultiplier}"

# Player Character Stamina Drain Multiplier
PlayerCharacterStaminaDrainMultiplier=$(checkDouble $PlayerCharacterStaminaDrainMultiplier 1.0)
executeString="${executeString}?PlayerCharacterStaminaDrainMultiplier=${PlayerCharacterStaminaDrainMultiplier}"

# Player Character Health Recovery Multiplier
PlayerCharacterHealthRecoveryMultiplier=$(checkDouble $PlayerCharacterHealthRecoveryMultiplier 1.0)
executeString="${executeString}?PlayerCharacterHealthRecoveryMultiplier=${PlayerCharacterHealthRecoveryMultiplier}"

# Dino Character Food Drain Multiplier
DinoCharacterFoodDrainMultiplier=$(checkDouble $DinoCharacterFoodDrainMultiplier 1.0)
executeString="${executeString}?DinoCharacterFoodDrainMultiplier=${DinoCharacterFoodDrainMultiplier}"

# Dino Character Stamina Drain Multiplier
DinoCharacterStaminaDrainMultiplier=$(checkDouble $DinoCharacterStaminaDrainMultiplier 1.0)
executeString="${executeString}?DinoCharacterStaminaDrainMultiplier=${DinoCharacterStaminaDrainMultiplier}"

# Dino Character Health Recovery Multiplier
DinoCharacterHealthRecoveryMultiplier=$(checkDouble $DinoCharacterHealthRecoveryMultiplier 1.0)
executeString="${executeString}?DinoCharacterHealthRecoveryMultiplier=${DinoCharacterHealthRecoveryMultiplier}"

# Dino Count Multiplier
DinoCountMultiplier=$(checkDouble $DinoCountMultiplier 1.0)
executeString="${executeString}?DinoCountMultiplier=${DinoCountMultiplier}"

# Difficulty Offset
difficulty=$(checkDouble $difficulty 0.2)
executeString="${executeString}?DifficultyOffset=${difficulty}"


# Server
executeString="${executeString} -server -log"


sleep 1s; echo -e " Check complete, starting server compiling."


echo -e; echo -e " Executing commandline in screen session named:$YELLOW $sessionName $RESET"
# Run Server
cd ../
cd $gameDir
screen -A -m -d -S $sessionName ./$arkExecute $executeString

echo -e; echo -e "$GREEN Server is starting up. To access the console, relaunch the script and use: ./arkserver.sh view $RESET"
echo -e; exit 0
